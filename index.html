<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Ultra Pro V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #1e293b;
            --glass: rgba(255, 255, 255, 0.95); --shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        body { margin: 0; overflow: hidden; font-family: 'Cairo', sans-serif; background: #cbd5e1; touch-action: none; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { position: fixed; inset: 0; background: radial-gradient(circle, #1e3c72, #2a5298); z-index: 5000; display: flex; align-items: center; justify-content: center; transition: 0.5s; }
        .card { background: white; padding: 40px; border-radius: 30px; box-shadow: var(--shadow); width: 90%; max-width: 450px; text-align: center; border: 4px solid var(--primary); }
        .input-name { width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 12px; border: 2px solid #ddd; font-size: 18px; outline: none; box-sizing: border-box; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        #main-ui { display: none; }
        #toolbar { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); 
            background: var(--glass); backdrop-filter: blur(15px); padding: 12px 25px; 
            border-radius: 25px; box-shadow: var(--shadow); display: flex; gap: 12px; 
            align-items: center; z-index: 1000; border: 1px solid rgba(255,255,255,0.3);
        }

        /* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        #side-tools { 
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%); 
            display: flex; flex-direction: column; gap: 10px; z-index: 1000; 
        }

        .tool-btn { 
            width: 50px; height: 50px; border-radius: 15px; border: none; 
            background: white; cursor: pointer; font-size: 22px; transition: 0.3s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; 
        }
        .tool-btn:hover { transform: scale(1.1); background: #f0f0f0; }
        .tool-btn.active { background: var(--primary); color: white; transform: translateY(-5-px); }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª */
        #pages-nav { position: fixed; top: 20px; left: 20px; display: flex; gap: 10px; z-index: 1000; background: var(--glass); padding: 10px; border-radius: 15px; }

        canvas { display: block; background: #fff; cursor: crosshair; }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ù„ÙŠØ²Ø± */
        #laser-dot { 
            position: fixed; width: 15px; height: 15px; background: red; 
            border-radius: 50%; box-shadow: 0 0 15px red; pointer-events: none; 
            display: none; z-index: 4000; 
        }

        .status-badge { position: fixed; top: 20px; right: 20px; background: var(--dark); color: white; padding: 5px 15px; border-radius: 20px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card">
            <h1>ğŸš€ Rocket V3 Ultra</h1>
            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠ</p>
            <input type="text" id="userName" class="input-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„...">
            <button onclick="app.login('student')" style="background:#10b981; color:white; width:100%; padding:15px; border:none; border-radius:12px; cursor:pointer; font-weight:bold; margin-bottom:10px; font-size:18px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
            <button onclick="app.login('teacher')" style="background:var(--primary); color:white; width:100%; padding:15px; border:none; border-radius:12px; cursor:pointer; font-weight:bold; font-size:18px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… (PRO)</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="status-badge" id="user-status">Ù…ØªØµÙ„: Ø²Ø§Ø¦Ø±</div>
        <div id="laser-dot"></div>

        <div id="pages-nav">
            <button class="tool-btn" onclick="app.prevPage()">â—€</button>
            <span id="page-num" style="align-self:center; font-weight:bold;">ØµÙØ­Ø© 1</span>
            <button class="tool-btn" onclick="app.nextPage()">â–¶</button>
        </div>

        <div id="side-tools">
            <button class="tool-btn" title="Ù…Ø³ØªØ·ÙŠÙ„" onclick="app.setMode('rect', this)">ğŸŸ¦</button>
            <button class="tool-btn" title="Ø¯Ø§Ø¦Ø±Ø©" onclick="app.setMode('circle', this)">â­•</button>
            <button class="tool-btn" title="Ø³Ù‡Ù…" onclick="app.setMode('arrow', this)">ğŸ¹</button>
            <button class="tool-btn" title="Ù„ÙŠØ²Ø±" onclick="app.setMode('laser', this)">ğŸš¨</button>
        </div>

        <div id="toolbar">
            <input type="color" id="colorPicker" value="#4361ee" style="border:none; width:40px; height:40px; cursor:pointer;">
            <input type="range" id="sizePicker" min="1" max="50" value="5">
            <button class="tool-btn active" onclick="app.setMode('pen', this)">âœï¸</button>
            <button class="tool-btn" onclick="app.setMode('neon', this)">ğŸŒŸ</button>
            <button class="tool-btn" onclick="app.setMode('eraser', this)">ğŸ§½</button>
            <button class="tool-btn" onclick="app.undo()">â†©ï¸</button>
            <button class="tool-btn" onclick="app.saveImage()">ğŸ’¾</button>
            <button class="tool-btn" style="color:red" onclick="app.clearAll()">ğŸ—‘ï¸</button>
        </div>
    </div>

    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, onDisconnect, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§ Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ÙƒÙˆØ¯)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "YOUR_APP_ID"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);

        const app = {
            canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            isAdmin: false,
            mode: 'pen',
            isDrawing: false,
            drawings: {},
            currentPage: 1,
            camera: { x: 0, y: 0, zoom: 1 },
            
            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.listenToFirebase();
                this.renderLoop();
                this.setupInputs();
            },

            login(role) {
                const name = document.getElementById('userName').value;
                if(!name) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ!");
                if(role === 'teacher' && prompt("ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù…:") !== "123") return;

                this.isAdmin = (role === 'teacher');
                document.getElementById('auth-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('main-ui').style.display = 'block';
                }, 500);
                
                document.getElementById('user-status').innerText = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${name} (${this.isAdmin ? 'Ù…Ø¹Ù„Ù…' : 'Ø·Ø§Ù„Ø¨'})`;
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            setMode(m, btn) {
                this.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            },

            setupInputs() {
                const handleStart = (e) => {
                    if(!this.isAdmin && this.mode !== 'laser') return;
                    this.isDrawing = true;
                    const pos = this.getPos(e);
                    this.startX = pos.x;
                    this.startY = pos.y;
                    this.currentPath = [{x: pos.x, y: pos.y}];
                };

                const handleMove = (e) => {
                    const pos = this.getPos(e);
                    if(this.mode === 'laser') {
                        this.showLaser(e.clientX, e.clientY);
                        return;
                    }
                    if(!this.isDrawing) return;
                    this.currentPath.push({x: pos.x, y: pos.y});
                    this.tempEnd = {x: pos.x, y: pos.y};
                };

                const handleEnd = () => {
                    if(!this.isDrawing) return;
                    this.isDrawing = false;
                    this.saveToFirebase();
                };

                this.canvas.addEventListener('pointerdown', handleStart);
                this.canvas.addEventListener('pointermove', handleMove);
                this.canvas.addEventListener('pointerup', handleEnd);
            },

            getPos(e) {
                return {
                    x: (e.clientX - this.camera.x) / this.camera.zoom,
                    y: (e.clientY - this.camera.y) / this.camera.zoom
                };
            },

            showLaser(x, y) {
                const dot = document.getElementById('laser-dot');
                dot.style.display = 'block';
                dot.style.left = x + 'px';
                dot.style.top = y + 'px';
                setTimeout(() => dot.style.display = 'none', 1000);
            },

            saveToFirebase() {
                const data = {
                    type: this.mode,
                    color: document.getElementById('colorPicker').value,
                    size: document.getElementById('sizePicker').value,
                    page: this.currentPage,
                    points: this.currentPath,
                    startX: this.startX,
                    startY: this.startY,
                    endX: this.tempEnd?.x,
                    endY: this.tempEnd?.y
                };
                push(ref(db, `board_data/page_${this.currentPage}`), data);
            },

            listenToFirebase() {
                onValue(ref(db, `board_data/page_${this.currentPage}`), (snapshot) => {
                    this.drawings = snapshot.val() || {};
                });
            },

            renderLoop() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.save();
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                // Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®Ø²Ù†Ø©
                Object.values(this.drawings).forEach(item => this.drawItem(item));

                // Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                if(this.isDrawing) {
                    this.drawItem({
                        type: this.mode,
                        color: document.getElementById('colorPicker').value,
                        size: document.getElementById('sizePicker').value,
                        points: this.currentPath,
                        startX: this.startX, startY: this.startY,
                        endX: this.tempEnd?.x, endY: this.tempEnd?.y
                    });
                }

                this.ctx.restore();
                requestAnimationFrame(() => this.renderLoop());
            },

            drawItem(it) {
                this.ctx.beginPath();
                this.ctx.strokeStyle = it.color;
                this.ctx.lineWidth = it.size;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';

                if(it.type === 'pen' || it.type === 'eraser' || it.type === 'neon') {
                    if(it.type === 'eraser') this.ctx.strokeStyle = '#fff';
                    if(it.type === 'neon') {
                        this.ctx.shadowBlur = 15;
                        this.ctx.shadowColor = it.color;
                    }
                    this.ctx.moveTo(it.points[0].x, it.points[0].y);
                    it.points.forEach(p => this.ctx.lineTo(p.x, p.y));
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                } else if(it.type === 'rect') {
                    this.ctx.strokeRect(it.startX, it.startY, it.endX - it.startX, it.endY - it.startY);
                } else if(it.type === 'circle') {
                    let r = Math.hypot(it.endX - it.startX, it.endY - it.startY);
                    this.ctx.arc(it.startX, it.startY, r, 0, Math.PI*2);
                    this.ctx.stroke();
                } else if(it.type === 'arrow') {
                    this.drawArrow(it.startX, it.startY, it.endX, it.endY);
                }
            },

            drawArrow(x1, y1, x2, y2) {
                const headlen = 15;
                const angle = Math.atan2(y2 - y1, x2 - x1);
                this.ctx.moveTo(x1, y1);
                this.ctx.lineTo(x2, y2);
                this.ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
                this.ctx.moveTo(x2, y2);
                this.ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
                this.ctx.stroke();
            },

            undo() {
                const lastRef = query(ref(db, `board_data/page_${this.currentPage}`), limitToLast(1));
                get(lastRef).then(s => {
                    if(s.exists()) remove(ref(db, `board_data/page_${this.currentPage}/${Object.keys(s.val())[0]}`));
                });
            },

            nextPage() { this.currentPage++; this.updatePage(); },
            prevPage() { if(this.currentPage > 1) this.currentPage--; this.updatePage(); },
            updatePage() {
                document.getElementById('page-num').innerText = `ØµÙØ­Ø© ${this.currentPage}`;
                this.listenToFirebase();
            },

            clearAll() {
                if(confirm("ØªÙ…Ø³Ø­ ÙƒÙ„ Ø­Ø§Ø¬Ø©ØŸ")) remove(ref(db, `board_data/page_${this.currentPage}`));
            },

            saveImage() {
                const link = document.createElement('a');
                link.download = 'board.png';
                link.href = this.canvas.toDataURL();
                link.click();
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>
