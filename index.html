<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket Turbo V3 - THE MONSTER EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.9); --shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Cairo', sans-serif; background: #1e293b; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        #auth-screen { position: fixed; inset: 0; background: radial-gradient(circle, #1e3c72, #000); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .card { background: white; padding: 40px; border-radius: 30px; box-shadow: var(--shadow); width: 90%; max-width: 450px; text-align: center; transform: scale(1); animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .input-name { width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 15px; border: 2px solid #e2e8f0; font-size: 18px; outline: none; text-align: center; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª) */
        .top-bar { position: fixed; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .badge { background: var(--glass); padding: 8px 15px; border-radius: 20px; box-shadow: var(--shadow); pointer-events: auto; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 8px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠ - Ø§Ù„Ù…Ø·ÙˆØ± */
        #toolbar { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); 
            background: var(--glass); backdrop-filter: blur(20px); padding: 10px 20px; 
            border-radius: 30px; box-shadow: var(--shadow); display: none; gap: 10px; 
            align-items: center; z-index: 2000; flex-wrap: wrap; max-width: 95vw;
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ø· */
        #side-menu { 
            position: fixed; right: 20px; top: 50%; transform: translateY(-50%); 
            display: none; flex-direction: column; gap: 10px; z-index: 2000; 
        }

        .tool-btn { 
            width: 48px; height: 48px; border-radius: 12px; border: none; 
            background: white; cursor: pointer; font-size: 20px; transition: 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .tool-btn:hover { background: var(--primary); color: white; transform: scale(1.1); }
        .tool-btn.active { background: var(--primary); color: white; box-shadow: 0 0 20px var(--primary); }
        .tool-btn[title]:hover::after { content: attr(title); position: absolute; right: 60px; background: black; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; white-space: nowrap; }

        /* Ø§Ù„Ù‚Ù…Ø§Ø´ (Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠØ©) */
        #board { background: #fff; touch-action: none; cursor: crosshair; }
        
        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ù„ÙŠØ²Ø± ÙˆØ§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø­ÙŠ */
        .live-cursor { position: absolute; pointer-events: none; width: 20px; height: 20px; z-index: 1500; font-size: 12px; white-space: nowrap; font-weight: bold; }
        #laser-pointer { position: absolute; width: 12px; height: 12px; background: red; border-radius: 50%; box-shadow: 0 0 15px red; display: none; pointer-events: none; z-index: 3000; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø·Ù„Ø§Ø¨ */
        #chat-box { position: fixed; bottom: 90px; right: 20px; width: 250px; height: 300px; background: var(--glass); border-radius: 20px; display: none; flex-direction: column; overflow: hidden; box-shadow: var(--shadow); z-index: 1000; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
        #chat-input { border: none; padding: 10px; outline: none; background: #eee; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„ (Popup) */
        .shapes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card">
            <h1>ğŸš€ Rocket V3 Pro Max</h1>
            <p>Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© (80+ Ù…ÙŠØ²Ø©)</p>
            <input type="text" id="userName" class="input-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©...">
            <button onclick="rocket.login('student')" style="background:#10b981; color:white; width:100%; padding:15px; border:none; border-radius:15px; cursor:pointer; font-weight:bold; margin-bottom:10px; font-size:18px;">Ø¯Ø®ÙˆÙ„ Ø·Ø§Ù„Ø¨</button>
            <button onclick="rocket.login('teacher')" style="background:var(--primary); color:white; width:100%; padding:15px; border:none; border-radius:15px; cursor:pointer; font-weight:bold; font-size:18px;">Ø¯Ø®ÙˆÙ„ Ù…Ø¹Ù„Ù…</button>
        </div>
    </div>

    <div class="top-bar">
        <div style="display:flex; gap:10px; pointer-events:auto;">
            <div class="badge" id="zoom-info">ğŸ” 100%</div>
            <div class="badge" id="status-online">ğŸŸ¢ Ù…ØªØµÙ„: 0</div>
            <div class="badge" id="timer">â³ 00:00</div>
        </div>
        <div class="badge" id="user-tag" style="pointer-events:auto;">ğŸ‘¤ Ø²Ø§Ø¦Ø±</div>
    </div>

    <div id="laser-pointer"></div>

    <div id="side-menu">
        <button class="tool-btn" title="Ø£Ø¯ÙˆØ§Øª Ù‡Ù†Ø¯Ø³ÙŠØ©" onclick="rocket.toggleMenu('shapes')">ğŸ“</button>
        <button class="tool-btn" title="Ø±Ù…ÙˆØ² ÙÙŠØ²ÙŠØ§Ø¡ ÙˆÙƒÙŠÙ…ÙŠØ§Ø¡" onclick="rocket.toggleMenu('science')">ğŸ§ª</button>
        <button class="tool-btn" title="Ø®Ø±Ø§Ø¦Ø· Ø°Ù‡Ù†ÙŠØ©" onclick="rocket.setMode('mindmap')">ğŸ§ </button>
        <button class="tool-btn" title="Ø±ÙØ¹ ØµÙˆØ±Ø©" onclick="document.getElementById('imgInput').click()">ğŸ–¼ï¸</button>
        <input type="file" id="imgInput" hidden accept="image/*" onchange="rocket.uploadImage(event)">
        <button class="tool-btn" title="ÙŠÙˆØªÙŠÙˆØ¨" onclick="rocket.addYoutube()">ğŸ“º</button>
        <button class="tool-btn" title="Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ø§ØµÙ‚Ø©" onclick="rocket.setMode('sticky')">ğŸ“</button>
    </div>

    <div id="toolbar">
        <input type="color" id="colorPicker" class="tool-btn" style="padding:0; width:40px; height:40px; border:none;">
        <input type="range" id="sizePicker" min="1" max="100" value="5" title="Ø­Ø¬Ù… Ø§Ù„Ø®Ø·">
        <button class="tool-btn active" id="btn-pen" onclick="rocket.setMode('pen', this)" title="Ù‚Ù„Ù… (P)">âœï¸</button>
        <button class="tool-btn" onclick="rocket.setMode('neon', this)" title="Ù‚Ù„Ù… Ù†ÙŠÙˆÙ†">ğŸŒŸ</button>
        <button class="tool-btn" onclick="rocket.setMode('highlighter', this)" title="Ù‚Ù„Ù… ØªÙ…ÙŠÙŠØ²">ğŸ–ï¸</button>
        <button class="tool-btn" onclick="rocket.setMode('eraser', this)" title="Ù…Ù…Ø­Ø§Ø© (E)">ğŸ§½</button>
        <button class="tool-btn" onclick="rocket.setMode('move', this)" title="ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù‚Ù…Ø§Ø´ (H)">ğŸ–ï¸</button>
        <button class="tool-btn" onclick="rocket.setMode('text', this)" title="Ù†Øµ">âœï¸</button>
        <div style="width:2px; height:30px; background:#ddd; margin:0 5px;"></div>
        <button class="tool-btn" onclick="rocket.undo()" title="ØªØ±Ø§Ø¬Ø¹ (Ctrl+Z)">â†©ï¸</button>
        <button class="tool-btn" onclick="rocket.toggleChat()" title="Ø¯Ø±Ø¯Ø´Ø©">ğŸ’¬</button>
        <button class="tool-btn" onclick="rocket.save('pdf')" title="Ø­ÙØ¸ PDF">ğŸ“„</button>
        <button class="tool-btn" style="color:red" onclick="rocket.clearBoard()" title="Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„">ğŸ—‘ï¸</button>
    </div>

    <div id="chat-box">
        <div style="background:var(--primary); color:white; padding:10px; font-weight:bold;">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­ÙŠØ©</div>
        <div id="chat-msgs"></div>
        <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="rocket.sendChat(event)">
    </div>

    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, onDisconnect, query, limitToLast, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡Ù†Ø§
        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            isAdmin: false,
            mode: 'pen',
            isDrawing: false,
            drawings: {},
            camera: { x: 0, y: 0, zoom: 1 },
            userName: "Ø²Ø§Ø¦Ø±",
            currentPath: [],
            cursors: {},

            init() {
                this.resize();
                window.onresize = () => this.resize();
                this.setupEvents();
                this.syncData();
                this.render();
                this.startTimer();
            },

            login(role) {
                const name = document.getElementById('userName').value;
                if(!name) return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ!");
                if(role === 'teacher' && prompt("Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…:") !== "123") return;
                
                this.isAdmin = (role === 'teacher');
                this.userName = name;
                document.getElementById('auth-screen').style.transform = 'translateY(-100%)';
                document.getElementById('toolbar').style.display = 'flex';
                document.getElementById('side-menu').style.display = 'flex';
                document.getElementById('user-tag').innerText = `ğŸ‘¤ ${name} (${this.isAdmin ? 'Ù…Ø¹Ù„Ù…' : 'Ø·Ø§Ù„Ø¨'})`;
                
                // ØªÙˆØ§Ø¬Ø¯ Ø­ÙŠ
                const presenceRef = ref(db, `presence/${name}`);
                set(presenceRef, { active: true, role: role });
                onDisconnect(presenceRef).remove();
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            setupEvents() {
                this.canvas.addEventListener('pointerdown', e => this.onStart(e));
                this.canvas.addEventListener('pointermove', e => this.onMove(e));
                this.canvas.addEventListener('pointerup', e => this.onEnd(e));
                window.addEventListener('wheel', e => this.onZoom(e), { passive: false });
                
                // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                window.addEventListener('keydown', e => {
                    if(e.ctrlKey && e.key === 'z') this.undo();
                    if(e.key === 'p') this.setMode('pen', document.getElementById('btn-pen'));
                });
            },

            getPos(e) {
                return {
                    x: (e.clientX - this.camera.x) / this.camera.zoom,
                    y: (e.clientY - this.camera.y) / this.camera.zoom
                };
            },

            onStart(e) {
                if(!this.isAdmin && this.mode !== 'move') return;
                this.isDrawing = true;
                const pos = this.getPos(e);
                this.startX = pos.x;
                this.startY = pos.y;
                this.currentPath = [{x: pos.x, y: pos.y}];
            },

            onMove(e) {
                const pos = this.getPos(e);
                
                // ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„Ø¢Ø®Ø±ÙŠÙ†
                if(this.isAdmin) set(ref(db, `cursors/${this.userName}`), { x: e.clientX, y: e.clientY });

                if(!this.isDrawing) return;

                if(this.mode === 'move') {
                    this.camera.x += e.movementX;
                    this.camera.y += e.movementY;
                } else {
                    this.currentPath.push({x: pos.x, y: pos.y});
                    this.tempEnd = pos;
                }
            },

            onEnd() {
                if(!this.isDrawing) return;
                this.isDrawing = false;
                if(this.mode !== 'move') this.pushToFirebase();
            },

            onZoom(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                this.camera.zoom *= delta;
                document.getElementById('zoom-info').innerText = `ğŸ” ${Math.round(this.camera.zoom*100)}%`;
            },

            pushToFirebase() {
                const data = {
                    type: this.mode,
                    color: document.getElementById('colorPicker').value,
                    size: document.getElementById('sizePicker').value,
                    points: this.currentPath,
                    startX: this.startX, startY: this.startY,
                    endX: this.tempEnd?.x, endY: this.tempEnd?.y,
                    user: this.userName
                };
                push(ref(db, 'board_data'), data);
            },

            syncData() {
                onValue(ref(db, 'board_data'), s => { this.drawings = s.val() || {}; });
                onValue(ref(db, 'cursors'), s => { this.cursors = s.val() || {}; });
                onValue(ref(db, 'presence'), s => {
                    document.getElementById('status-online').innerText = `ğŸŸ¢ Ù…ØªØµÙ„: ${s.size || 0}`;
                });
            },

            render() {
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                // Ø±Ø³Ù… ÙƒÙ„ Ø´ÙŠØ¡
                Object.values(this.drawings).forEach(it => this.drawItem(it));

                // Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                if(this.isDrawing && this.mode !== 'move') {
                    this.drawItem({
                        type: this.mode, color: document.getElementById('colorPicker').value,
                        size: document.getElementById('sizePicker').value,
                        points: this.currentPath, startX: this.startX, startY: this.startY,
                        endX: this.tempEnd?.x, endY: this.tempEnd?.y
                    });
                }

                requestAnimationFrame(() => this.render());
            },

            drawItem(it) {
                this.ctx.beginPath();
                this.ctx.strokeStyle = it.color;
                this.ctx.lineWidth = it.size;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';

                if(['pen', 'neon', 'highlighter', 'eraser'].includes(it.type)) {
                    if(it.type === 'eraser') this.ctx.strokeStyle = '#fff';
                    if(it.type === 'neon') { this.ctx.shadowBlur = 10; this.ctx.shadowColor = it.color; }
                    if(it.type === 'highlighter') this.ctx.globalAlpha = 0.4;
                    
                    this.ctx.moveTo(it.points[0].x, it.points[0].y);
                    it.points.forEach(p => this.ctx.lineTo(p.x, p.y));
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1; this.ctx.shadowBlur = 0;
                } else if(it.type === 'rect') {
                    this.ctx.strokeRect(it.startX, it.startY, it.endX - it.startX, it.endY - it.startY);
                } else if(it.type === 'circle') {
                    let r = Math.hypot(it.endX - it.startX, it.endY - it.startY);
                    this.ctx.arc(it.startX, it.startY, r, 0, Math.PI*2);
                    this.ctx.stroke();
                }
            },

            setMode(m, btn) {
                this.mode = m;
                if(btn) {
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            },

            undo() {
                const q = query(ref(db, 'board_data'), limitToLast(1));
                get(q).then(s => { if(s.exists()) remove(ref(db, `board_data/${Object.keys(s.val())[0]}`)); });
            },

            clearBoard() { if(confirm("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) remove(ref(db, 'board_data')); },

            startTimer() {
                let sec = 0;
                setInterval(() => {
                    sec++;
                    let m = Math.floor(sec/60);
                    let s = sec%60;
                    document.getElementById('timer').innerText = `â³ ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                }, 1000);
            },

            toggleChat() {
                const chat = document.getElementById('chat-box');
                chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
            },

            sendChat(e) {
                if(e.key === 'Enter') {
                    const input = document.getElementById('chat-input');
                    push(ref(db, 'chat'), { user: this.userName, msg: input.value });
                    input.value = "";
                }
            },
            
            uploadImage(e) {
                alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„ØµÙˆØ± - Ø³ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ");
                // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Cloudinary Ø£Ùˆ Firebase Storage
            }
        };

        window.rocket = rocket;
        rocket.init();

        // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
        onValue(ref(db, 'chat'), s => {
            const cont = document.getElementById('chat-msgs');
            cont.innerHTML = "";
            s.forEach(c => {
                cont.innerHTML += `<div><b>${c.val().user}:</b> ${c.val().msg}</div>`;
            });
            cont.scrollTop = cont.scrollHeight;
        });
    </script>
</body>
</html>
