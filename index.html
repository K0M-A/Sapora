<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket - KAREEM OMAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #0f172a; 
            --glass: rgba(255, 255, 255, 0.95); --shadow: 0 10px 30px rgba(0,0,0,0.15); 
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Cairo', sans-serif; 
            background: #f8fafc; touch-action: none; user-select: none; 
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { position: fixed; inset: 0; background: radial-gradient(circle at center, #1e293b, #0f172a); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 25px; width: 100%; max-width: 450px; text-align: center; box-shadow: var(--shadow); }
        .input-group { margin-bottom: 15px; text-align: right; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--dark); }
        .input-group input { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #e2e8f0; box-sizing: border-box; outline: none; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); }

        /* ØªÙˆØ¨ Ø¨Ø§Ø± */
        .top-bar { position: fixed; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .badge { background: var(--glass); padding: 8px 15px; border-radius: 12px; font-size: 13px; font-weight: bold; pointer-events: auto; box-shadow: var(--shadow); display: inline-flex; align-items: center; gap: 8px; border: 1px solid #eee; margin: 2px; border:none; cursor: pointer; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        #main-toolbar { 
            position: fixed; background: var(--glass); padding: 10px; border-radius: 20px; 
            box-shadow: var(--shadow); display: none; gap: 8px; align-items: center; 
            z-index: 2000; border: 1px solid rgba(0,0,0,0.05);
        }

        /* Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ· */
        .pos-bottom #main-toolbar { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; }
        .pos-top #main-toolbar { top: 70px; left: 50%; transform: translateX(-50%); flex-direction: row; }
        .pos-right #main-toolbar { right: 20px; top: 50%; transform: translateY(-50%); flex-direction: column; }
        .pos-left #main-toolbar { left: 20px; top: 50%; transform: translateY(-50%); flex-direction: column; }

        .tool-btn { width: 45px; height: 45px; border-radius: 12px; border: none; background: #f1f5f9; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; color: #475569; }
        .tool-btn:hover { background: #e2e8f0; }
        .tool-btn.active { background: var(--primary); color: white; }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ© */
        .sub-menu { 
            position: absolute; background: white; padding: 12px; border-radius: 15px; 
            display: none; gap: 8px; box-shadow: var(--shadow); z-index: 2001; 
            border: 1px solid #eee; flex-direction: column; align-items: center;
        }
        .show-menu { display: flex !important; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ø§Ù„Ø´Ø±ÙŠØ· */
        .pos-bottom .sub-menu { bottom: 60px; left: 50%; transform: translateX(-50%); }
        .pos-top .sub-menu { top: 60px; left: 50%; transform: translateX(-50%); }
        .pos-right .sub-menu { right: 60px; top: 50%; transform: translateY(-50%); }
        .pos-left .sub-menu { left: 60px; top: 50%; transform: translateY(-50%); }

        .color-grid { display: grid !important; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 180px; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.1); }

        /* Ø´Ø§Øª ÙˆØ£Ø¯ÙˆØ§Øª */
        #chat-panel { position: fixed; bottom: 80px; left: 20px; width: 300px; height: 400px; background: white; border-radius: 20px; box-shadow: var(--shadow); display: none; flex-direction: column; z-index: 2500; overflow: hidden; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #fcfcfc; }
        .msg { padding: 10px; border-radius: 12px; font-size: 13px; position: relative; max-width: 80%; }
        .msg-me { background: var(--primary); color: white; align-self: flex-start; }
        .msg-them { background: #e2e8f0; color: #333; align-self: flex-end; }
        .del-msg { cursor: pointer; color: var(--accent); margin-right: 5px; font-size: 10px; }

        .geo-tool { position: absolute; background: rgba(255,255,255,0.7); border: 2px solid var(--primary); cursor: move; display: none; z-index: 500; backdrop-filter: blur(5px); }
        .ruler { height: 50px; width: 300px; border-bottom: 2px solid #333; background-image: repeating-linear-gradient(90deg, #333 0, #333 1px, transparent 1px, transparent 10px); }
        
        #board { background: white; cursor: crosshair; }
        #restore-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: white; border: none; z-index: 3000; display: none; cursor: pointer; box-shadow: var(--shadow); }
    </style>
</head>
<body class="pos-bottom">

    <div id="auth-screen">
        <div class="card">
            <h2 style="color:var(--primary)">ğŸš€ MONSTER ELITE ULTIMATE</h2>
            <div class="input-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±</label>
                <input type="text" id="userName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ...">
            </div>
            <div class="input-group">
                <label>Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© (ID)</label>
                <input type="text" id="roomID" placeholder="Ù…Ø«Ù„Ø§Ù‹: Math101">
            </div>
            <div class="input-group">
                <label>ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØºØ±ÙØ©</label>
                <input type="password" id="roomPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±...">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="rocket.login('teacher')" style="background:var(--dark); color:white; border:none; padding:15px; border-radius:12px; cursor:pointer;">Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¹Ù„Ù…</button>
                <button onclick="rocket.login('student')" style="background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; cursor:pointer;">Ø¯Ø®ÙˆÙ„ ÙƒØ·Ø§Ù„Ø¨</button>
            </div>
        </div>
    </div>

    <button id="restore-btn" onclick="rocket.toggleMinimize()"><i class="fas fa-rocket"></i></button>

    <div class="top-bar">
        <div>
            <div class="badge"><i class="fas fa-search-plus"></i> <span id="zoom-info">100%</span></div>
            <button class="badge" onclick="rocket.toggleFullscreen()"><i class="fas fa-expand"></i></button>
        </div>
        <div>
            <div class="badge"><i class="fas fa-door-open"></i> <span id="display-room">---</span></div>
            <div class="badge"><i class="fas fa-users"></i> <span id="user-count">0</span></div>
            <button class="badge" onclick="rocket.toggleChat()"><i class="fas fa-comments"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
        </div>
    </div>

    <div id="chat-panel">
        <div style="background:var(--dark); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span>Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØºØ±ÙØ©</span>
            <i class="fas fa-times" onclick="rocket.toggleChat()" style="cursor:pointer"></i>
        </div>
        <div id="chat-msgs"></div>
        <div style="padding:10px; display:flex; gap:5px; border-top:1px solid #eee;">
            <input type="text" id="chat-input" style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd;" placeholder="Ø§ÙƒØªØ¨..." onkeypress="if(event.key==='Enter') rocket.sendMsg()">
            <button onclick="rocket.sendMsg()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:8px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="main-toolbar">
        <button class="tool-btn" onclick="rocket.toggleMinimize()"><i class="fas fa-minus-circle"></i></button>
        
        <div id="teacher-tools" style="display:none; contents;">
            <div style="position:relative;">
                <button class="tool-btn" id="btn-color" onclick="rocket.toggleSubMenu('color-menu')"><i class="fas fa-palette"></i></button>
                <div id="color-menu" class="sub-menu color-grid">
                    <div class="color-dot" style="background:#000" onclick="rocket.updateColor('#000')"></div>
                    <div class="color-dot" style="background:#f00" onclick="rocket.updateColor('#f00')"></div>
                    <div class="color-dot" style="background:#00f" onclick="rocket.updateColor('#00f')"></div>
                    <div class="color-dot" style="background:#0b0" onclick="rocket.updateColor('#0b0')"></div>
                    <div class="color-dot" style="background:#f90" onclick="rocket.updateColor('#f90')"></div>
                </div>
            </div>

            <div style="position:relative;">
                <button class="tool-btn active" id="btn-pen" onclick="rocket.toggleSubMenu('pen-menu')"><i class="fas fa-pen"></i></button>
                <div id="pen-menu" class="sub-menu">
                    <button class="tool-btn" onclick="rocket.setMode('pen')"><i class="fas fa-pen"></i></button>
                    <button class="tool-btn" onclick="rocket.setMode('brush')"><i class="fas fa-paint-brush"></i></button>
                    <input type="range" min="1" max="50" value="3" oninput="rocket.currentThickness = this.value">
                </div>
            </div>

            <button class="tool-btn" onclick="rocket.setMode('eraser')"><i class="fas fa-eraser"></i></button>
            <button class="tool-btn" onclick="rocket.clearBoard()"><i class="fas fa-trash-alt"></i></button>
        </div>

        <button class="tool-btn" onclick="rocket.setMode('move')" id="btn-move"><i class="fas fa-arrows-alt"></i></button>
        
        <div style="display:flex; align-items:center; background:#eee; border-radius:10px; padding:2px;">
            <button class="tool-btn" style="width:30px;height:30px" onclick="rocket.changePage(-1)"><i class="fas fa-chevron-right"></i></button>
            <span id="page-label" style="margin:0 10px; font-weight:bold;">1</span>
            <button class="tool-btn" style="width:30px;height:30px" onclick="rocket.changePage(1)"><i class="fas fa-chevron-left"></i></button>
        </div>

        <select onchange="rocket.moveToolbar(this.value)" style="padding:5px; border-radius:8px; font-family:'Cairo'">
            <option value="bottom">Ø£Ø³ÙÙ„</option>
            <option value="top">Ø£Ø¹Ù„Ù‰</option>
            <option value="right">ÙŠÙ…ÙŠÙ†</option>
            <option value="left">ÙŠØ³Ø§Ø±</option>
        </select>
    </div>

    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onChildRemoved, remove, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            isAdmin: false, mode: 'move', canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            camera: { x: 0, y: 0, zoom: 1 }, drawings: {}, 
            currentColor: '#000', currentThickness: 3, currentPage: 1,
            room: '', userName: '', isDrawing: false, lastMouse: {x:0, y:0},

            init() {
                this.resize();
                window.onresize = () => this.resize();
                this.setupEvents();
                requestAnimationFrame(() => this.render());
            },

            async login(role) {
                const name = document.getElementById('userName').value.trim();
                const room = document.getElementById('roomID').value.trim();
                const pass = document.getElementById('roomPass').value.trim();

                if(!name || !room || !pass) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ§ Ø¨Ø·Ù„!");

                const roomRef = ref(db, `rooms/${room}/config`);
                onValue(roomRef, (snapshot) => {
                    const config = snapshot.val();
                    if(role === 'teacher') {
                        if(!config || config.pass === pass) {
                            set(roomRef, { pass: pass, teacher: name });
                            this.proceedLogin(name, room, true);
                        } else alert("Ø§Ù„ØºØ±ÙØ© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨ÙƒÙ„Ù…Ø© Ø³Ø± Ø£Ø®Ø±Ù‰!");
                    } else {
                        if(config && config.pass === pass) {
                            this.proceedLogin(name, room, false);
                        } else alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
                    }
                }, { onlyOnce: true });
            },

            proceedLogin(name, room, isAdmin) {
                this.userName = name;
                this.room = room;
                this.isAdmin = isAdmin;
                document.getElementById('display-room').innerText = room;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-toolbar').style.display = 'flex';
                if(isAdmin) document.getElementById('teacher-tools').style.display = 'contents';

                const uRef = push(ref(db, `rooms/${room}/users`));
                set(uRef, { name, role: isAdmin ? 'teacher' : 'student' });
                onDisconnect(uRef).remove();

                this.syncData();
            },

            syncData() {
                const roomPath = `rooms/${this.room}`;
                onChildAdded(ref(db, `${roomPath}/board`), s => this.drawings[s.key] = s.val());
                onChildRemoved(ref(db, `${roomPath}/board`), s => delete this.drawings[s.key]);
                
                onValue(ref(db, `${roomPath}/users`), s => {
                    document.getElementById('user-count').innerText = Object.keys(s.val() || {}).length;
                });

                onChildAdded(ref(db, `${roomPath}/chat`), s => {
                    const d = s.val();
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `msg ${d.user === this.userName ? 'msg-me' : 'msg-them'}`;
                    msgDiv.innerHTML = `
                        ${this.isAdmin ? `<i class="fas fa-trash del-msg" onclick="rocket.deleteMsg('${s.key}')"></i>` : ''}
                        <b>${d.user}:</b> ${d.text}
                    `;
                    msgDiv.id = `msg-${s.key}`;
                    document.getElementById('chat-msgs').appendChild(msgDiv);
                    document.getElementById('chat-msgs').scrollTop = 9999;
                });

                onChildRemoved(ref(db, `${roomPath}/chat`), s => {
                    document.getElementById(`msg-${s.key}`)?.remove();
                });
            },

            setupEvents() {
                const getPos = (e) => {
                    const r = this.canvas.getBoundingClientRect();
                    const cx = e.clientX || e.touches?.[0].clientX;
                    const cy = e.clientY || e.touches?.[0].clientY;
                    return {
                        x: (cx - r.left - this.camera.x) / this.camera.zoom,
                        y: (cy - r.top - this.camera.y) / this.camera.zoom
                    };
                };

                this.canvas.addEventListener('pointerdown', e => {
                    this.closeAllMenus();
                    const pos = getPos(e);
                    if(this.mode === 'move' || !this.isAdmin) {
                        this.isDragging = true;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    } else {
                        this.isDrawing = true;
                        this.currentPath = [{x: pos.x, y: pos.y}];
                    }
                });

                window.addEventListener('pointermove', e => {
                    if(this.isDragging) {
                        this.camera.x += e.clientX - this.lastMouse.x;
                        this.camera.y += e.clientY - this.lastMouse.y;
                        this.lastMouse = { x: e.clientX, y: e.clientY };
                    } else if(this.isDrawing) {
                        this.currentPath.push(getPos(e));
                    }
                });

                window.addEventListener('pointerup', () => {
                    if(this.isDrawing && this.currentPath.length > 1) {
                        push(ref(db, `rooms/${this.room}/board`), {
                            points: this.currentPath, color: this.currentColor,
                            thickness: this.currentThickness, mode: this.mode, page: this.currentPage
                        });
                    }
                    this.isDrawing = this.isDragging = false;
                });
            },

            render() {
                this.ctx.setTransform(1,0,0,1,0,0);
                this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                Object.values(this.drawings).forEach(d => {
                    if(d.page === this.currentPage) this.drawPath(d);
                });

                if(this.isDrawing) this.drawPath({points: this.currentPath, color: this.currentColor, thickness: this.currentThickness, mode: this.mode});
                requestAnimationFrame(() => this.render());
            },

            drawPath(d) {
                this.ctx.beginPath();
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.lineWidth = d.thickness;
                this.ctx.strokeStyle = d.color;
                
                if(d.mode === 'eraser') this.ctx.globalCompositeOperation = 'destination-out';
                else this.ctx.globalCompositeOperation = 'source-over';

                this.ctx.moveTo(d.points[0].x, d.points[0].y);
                d.points.forEach(p => this.ctx.lineTo(p.x, p.y));
                this.ctx.stroke();
                this.ctx.globalCompositeOperation = 'source-over';
            },

            sendMsg() {
                const inp = document.getElementById('chat-input');
                if(!inp.value.trim()) return;
                push(ref(db, `rooms/${this.room}/chat`), { user: this.userName, text: inp.value });
                inp.value = '';
            },

            deleteMsg(key) {
                if(this.isAdmin) remove(ref(db, `rooms/${this.room}/chat/${key}`));
            },

            toggleSubMenu(id) {
                const el = document.getElementById(id);
                const isOpen = el.classList.contains('show-menu');
                this.closeAllMenus();
                if(!isOpen) el.classList.add('show-menu');
            },

            closeAllMenus() {
                document.querySelectorAll('.sub-menu').forEach(m => m.classList.remove('show-menu'));
            },

            updateColor(c) {
                this.currentColor = c;
                document.getElementById('btn-color').style.color = c;
                this.closeAllMenus();
            },

            setMode(m) {
                this.mode = m;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if(m === 'move') document.getElementById('btn-move').classList.add('active');
                else document.getElementById('btn-pen').classList.add('active');
                this.closeAllMenus();
            },

            moveToolbar(pos) {
                document.body.className = 'pos-' + pos;
                this.closeAllMenus();
            },

            changePage(n) {
                this.currentPage = Math.max(1, this.currentPage + n);
                document.getElementById('page-label').innerText = this.currentPage;
            },

            clearBoard() {
                if(confirm("Ù…Ø³Ø­ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
                    Object.keys(this.drawings).forEach(k => {
                        if(this.drawings[k].page === this.currentPage) remove(ref(db, `rooms/${this.room}/board/${k}`));
                    });
                }
            },

            toggleChat() {
                const p = document.getElementById('chat-panel');
                p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
            },

            toggleMinimize() {
                const bar = document.getElementById('main-toolbar');
                const btn = document.getElementById('restore-btn');
                const isHidden = bar.style.display === 'none';
                bar.style.display = isHidden ? 'flex' : 'none';
                btn.style.display = isHidden ? 'none' : 'block';
            },

            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
            toggleFullscreen() {
                if(!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            }
        };

        window.rocket = rocket;
        rocket.init();
    </script>
</body>
</html>
