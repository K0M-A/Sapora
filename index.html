<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Rocket Turbo V3 - ULTIMATE</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4361ee; --accent: #ff4757; --dark: #0f172a;
            --glass: rgba(255, 255, 255, 0.95); --shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Cairo', sans-serif; background: #f1f5f9; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3c72, #2a5298); z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 0.6s; }
        .card { background: white; padding: 35px; border-radius: 25px; box-shadow: var(--shadow); width: 90%; max-width: 400px; text-align: center; }
        .input-name { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 16px; text-align: center; box-sizing: border-box; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-bar { position: fixed; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 1000; pointer-events: none; }
        .badge { background: var(--glass); padding: 6px 15px; border-radius: 15px; box-shadow: var(--shadow); pointer-events: auto; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; border: 1px solid #eee; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ù…Ø±ØªØ¨ */
        #main-toolbar { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: var(--glass); backdrop-filter: blur(15px); padding: 8px 15px; 
            border-radius: 50px; box-shadow: var(--shadow); display: none; gap: 8px; 
            align-items: center; z-index: 2000; border: 1px solid rgba(0,0,0,0.05);
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© */
        .tool-btn { 
            width: 45px; height: 45px; border-radius: 50%; border: none; 
            background: #fff; cursor: pointer; font-size: 18px; transition: 0.3s; 
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .tool-btn:hover { background: #f0f0f0; transform: translateY(-3px); }
        .tool-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(67, 97, 238, 0.4); }

        /* Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø¨Ø«Ù‚Ø© (Popups) */
        .popup-menu {
            position: absolute; bottom: 70px; background: white; padding: 12px; 
            border-radius: 20px; box-shadow: var(--shadow); display: none; 
            grid-template-columns: repeat(3, 1fr); gap: 10px; min-width: 150px;
        }
        .show-popup { display: grid !important; }

        /* ØªØ®ØµÙŠØµ Ù…Ù†Ù‚ÙŠ Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
        #colorPreview { 
            width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; 
            cursor: pointer; box-shadow: 0 0 5px rgba(0,0,0,0.2); transition: 0.2s;
        }
        #colorPicker { position: absolute; visibility: hidden; }

        /* Ø§Ù„Ù‚Ù…Ø§Ø´ */
        #board { background: #ffffff; touch-action: none; cursor: crosshair; }

        /* Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        #chat-box { 
            position: fixed; bottom: 85px; right: 20px; width: 280px; height: 350px; 
            background: var(--glass); border-radius: 20px; display: none; flex-direction: column; 
            overflow: hidden; box-shadow: var(--shadow); z-index: 1000; border: 1px solid #eee;
        }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; font-size: 13px; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: #eef2ff; padding: 8px 12px; border-radius: 12px; align-self: flex-start; }
        .msg.me { background: var(--primary); color: white; align-self: flex-end; }
        #chat-input { border: none; padding: 15px; outline: none; background: #fff; border-top: 1px solid #eee; }

        /* Ø­Ø¬Ù… Ø§Ù„Ø®Ø· */
        .size-slider { width: 100px; accent-color: var(--primary); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="card">
            <h1 style="margin-top:0">ğŸš€ Rocket Turbo V3</h1>
            <p style="color:#64748b">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ø£Ù‚ÙˆÙ‰ - Monster Edition</p>
            <input type="text" id="userName" class="input-name" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±...">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="rocket.login('student')" style="background:#10b981; color:white; padding:12px; border:none; border-radius:12px; cursor:pointer; font-weight:bold;">Ø·Ø§Ù„Ø¨</button>
                <button onclick="rocket.login('teacher')" style="background:var(--primary); color:white; padding:12px; border:none; border-radius:12px; cursor:pointer; font-weight:bold;">Ù…Ø¹Ù„Ù…</button>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <div style="display:flex; gap:8px; pointer-events:auto;">
            <div class="badge" id="zoom-info">ğŸ” 100%</div>
            <div class="badge" id="status-online">ğŸŸ¢ Ù…ØªØµÙ„: 0</div>
            <div class="badge" id="timer">â³ 00:00</div>
        </div>
        <div class="badge" id="user-tag" style="pointer-events:auto;">ğŸ‘¤ Ø²Ø§Ø¦Ø±</div>
    </div>

    <div id="main-toolbar">
        <div style="position:relative">
            <div id="colorPreview" onclick="document.getElementById('colorPicker').click()"></div>
            <input type="color" id="colorPicker" onchange="rocket.updateColor(this.value)">
        </div>

        <div style="width:1px; height:30px; background:#ddd; margin:0 5px;"></div>

        <div style="position:relative">
            <button class="tool-btn active" id="btn-brush" onclick="rocket.togglePopup('brush-menu')" title="Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…">ğŸ–Œï¸</button>
            <div id="brush-menu" class="popup-menu">
                <button class="tool-btn" onclick="rocket.setMode('pen', 'âœï¸')">âœï¸</button>
                <button class="tool-btn" onclick="rocket.setMode('calligraphy', 'ğŸ–‹ï¸')">ğŸ–‹ï¸</button>
                <button class="tool-btn" onclick="rocket.setMode('neon', 'ğŸŒŸ')">ğŸŒŸ</button>
                <button class="tool-btn" onclick="rocket.setMode('highlighter', 'ğŸ–ï¸')">ğŸ–ï¸</button>
                <button class="tool-btn" onclick="rocket.setMode('oil', 'ğŸ¨')">ğŸ¨</button>
            </div>
        </div>

        <div style="position:relative">
            <button class="tool-btn" onclick="rocket.togglePopup('shape-menu')" title="Ø£Ø´ÙƒØ§Ù„ Ù‡Ù†Ø¯Ø³ÙŠØ©">ğŸ“</button>
            <div id="shape-menu" class="popup-menu">
                <button class="tool-btn" onclick="rocket.setMode('rect', 'â¬œ')">â¬œ</button>
                <button class="tool-btn" onclick="rocket.setMode('circle', 'â­•')">â­•</button>
                <button class="tool-btn" onclick="rocket.setMode('line', 'ğŸ“')">ğŸ“</button>
            </div>
        </div>

        <button class="tool-btn" onclick="rocket.setMode('eraser', 'ğŸ§½')" title="Ù…Ù…Ø­Ø§Ø©">ğŸ§½</button>
        <button class="tool-btn" onclick="rocket.setMode('move', 'ğŸ–ï¸')" title="ØªØ­Ø±ÙŠÙƒ">ğŸ–ï¸</button>
        
        <div style="width:1px; height:30px; background:#ddd; margin:0 5px;"></div>

        <input type="range" id="sizePicker" class="size-slider" min="1" max="50" value="5">

        <div style="width:1px; height:30px; background:#ddd; margin:0 5px;"></div>

        <button class="tool-btn" onclick="rocket.undo()" title="ØªØ±Ø§Ø¬Ø¹">â†©ï¸</button>
        <button class="tool-btn" onclick="rocket.toggleChat()" title="Ø¯Ø±Ø¯Ø´Ø©">ğŸ’¬</button>
        <button class="tool-btn" onclick="rocket.clearBoard()" style="color:red" title="Ù…Ø³Ø­">ğŸ—‘ï¸</button>
    </div>

    <div id="chat-box">
        <div style="background:var(--primary); color:white; padding:12px; font-weight:bold; display:flex; justify-content:space-between;">
            <span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø­ÙŠØ©</span>
            <span onclick="rocket.toggleChat()" style="cursor:pointer">âœ•</span>
        </div>
        <div id="chat-msgs"></div>
        <input type="text" id="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹..." onkeypress="rocket.sendChat(event)">
    </div>

    <canvas id="board"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, query, limitToLast, get, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            databaseURL: "https://sapora-f738b-default-rtdb.firebaseio.com",
            projectId: "sapora-f738b",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const rocket = {
            canvas: document.getElementById('board'),
            ctx: document.getElementById('board').getContext('2d'),
            isAdmin: false,
            mode: 'pen',
            isDrawing: false,
            drawings: {},
            camera: { x: 0, y: 0, zoom: 1 },
            userName: "Ø²Ø§Ø¦Ø±",
            currentColor: '#4361ee',
            currentPath: [],

            init() {
                this.resize();
                window.onresize = () => this.resize();
                document.getElementById('colorPreview').style.background = this.currentColor;
                this.setupEvents();
                this.syncData();
                this.render();
                this.startTimer();
            },

            login(role) {
                const name = document.getElementById('userName').value.trim();
                if(!name) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ");
                if(role === 'teacher' && prompt("ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø¹Ù„Ù…:") !== "123") return;
                
                this.isAdmin = (role === 'teacher');
                this.userName = name;
                document.getElementById('auth-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('main-toolbar').style.display = 'flex';
                }, 600);
                
                document.getElementById('user-tag').innerText = `ğŸ‘¤ ${name} (${this.isAdmin ? 'Ù…Ø¹Ù„Ù…' : 'Ø·Ø§Ù„Ø¨'})`;
                
                const presenceRef = ref(db, `presence/${name}`);
                set(presenceRef, { active: true, role: role });
                onDisconnect(presenceRef).remove();
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },

            setupEvents() {
                this.canvas.addEventListener('pointerdown', e => this.onStart(e));
                this.canvas.addEventListener('pointermove', e => this.onMove(e));
                this.canvas.addEventListener('pointerup', () => this.onEnd());
                window.addEventListener('wheel', e => this.onZoom(e), { passive: false });
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†
                document.addEventListener('click', (e) => {
                    if(!e.target.closest('.tool-btn') && !e.target.closest('.popup-menu')) {
                        document.querySelectorAll('.popup-menu').forEach(m => m.classList.remove('show-popup'));
                    }
                });
            },

            togglePopup(id) {
                const menu = document.getElementById(id);
                const isOpen = menu.classList.contains('show-popup');
                document.querySelectorAll('.popup-menu').forEach(m => m.classList.remove('show-popup'));
                if(!isOpen) menu.classList.add('show-popup');
            },

            updateColor(val) {
                this.currentColor = val;
                document.getElementById('colorPreview').style.background = val;
            },

            setMode(m, icon) {
                this.mode = m;
                document.getElementById('btn-brush').innerText = icon;
                document.querySelectorAll('.popup-menu').forEach(m => m.classList.remove('show-popup'));
            },

            getPos(e) {
                return {
                    x: (e.clientX - this.camera.x) / this.camera.zoom,
                    y: (e.clientY - this.camera.y) / this.camera.zoom
                };
            },

            onStart(e) {
                if(!this.isAdmin && this.mode !== 'move') return;
                this.isDrawing = true;
                const pos = this.getPos(e);
                this.startX = pos.x;
                this.startY = pos.y;
                this.currentPath = [{x: pos.x, y: pos.y}];
            },

            onMove(e) {
                if(!this.isDrawing) return;
                const pos = this.getPos(e);
                if(this.mode === 'move') {
                    this.camera.x += e.movementX;
                    this.camera.y += e.movementY;
                } else {
                    this.currentPath.push({x: pos.x, y: pos.y});
                    this.tempEnd = pos;
                }
            },

            onEnd() {
                if(!this.isDrawing) return;
                this.isDrawing = false;
                if(this.mode !== 'move') {
                    const data = {
                        type: this.mode,
                        color: this.currentColor,
                        size: document.getElementById('sizePicker').value,
                        points: this.currentPath,
                        startX: this.startX, startY: this.startY,
                        endX: this.tempEnd?.x, endY: this.tempEnd?.y
                    };
                    push(ref(db, 'board_data'), data);
                }
            },

            onZoom(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                this.camera.zoom *= delta;
                document.getElementById('zoom-info').innerText = `ğŸ” ${Math.round(this.camera.zoom*100)}%`;
            },

            syncData() {
                onValue(ref(db, 'board_data'), s => { this.drawings = s.val() || {}; });
                onValue(ref(db, 'presence'), s => {
                    document.getElementById('status-online').innerText = `ğŸŸ¢ Ù…ØªØµÙ„: ${s.size || 0}`;
                });
                onValue(ref(db, 'chat'), s => {
                    const cont = document.getElementById('chat-msgs');
                    cont.innerHTML = "";
                    s.forEach(c => {
                        const m = c.val();
                        const isMe = m.user === this.userName;
                        cont.innerHTML += `<div class="msg ${isMe?'me':''}"><b>${m.user}:</b><br>${m.msg}</div>`;
                    });
                    cont.scrollTop = cont.scrollHeight;
                });
            },

            drawItem(it) {
                this.ctx.beginPath();
                this.ctx.strokeStyle = it.color;
                this.ctx.lineWidth = it.size;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';

                const isPath = ['pen', 'neon', 'highlighter', 'calligraphy', 'oil', 'eraser'].includes(it.type);

                if(isPath) {
                    if(it.type === 'eraser') this.ctx.strokeStyle = '#ffffff';
                    if(it.type === 'neon') { this.ctx.shadowBlur = 15; this.ctx.shadowColor = it.color; }
                    if(it.type === 'highlighter') this.ctx.globalAlpha = 0.3;
                    if(it.type === 'calligraphy') this.ctx.lineWidth = it.size * 2;
                    if(it.type === 'oil') this.ctx.lineCap = 'square';

                    this.ctx.moveTo(it.points[0].x, it.points[0].y);
                    it.points.forEach(p => this.ctx.lineTo(p.x, p.y));
                    this.ctx.stroke();
                    this.ctx.globalAlpha = 1; this.ctx.shadowBlur = 0;
                } else if(it.type === 'rect') {
                    this.ctx.strokeRect(it.startX, it.startY, it.endX - it.startX, it.endY - it.startY);
                } else if(it.type === 'circle') {
                    let r = Math.hypot(it.endX - it.startX, it.endY - it.startY);
                    this.ctx.arc(it.startX, it.startY, r, 0, Math.PI*2);
                    this.ctx.stroke();
                } else if(it.type === 'line') {
                    this.ctx.moveTo(it.startX, it.startY);
                    this.ctx.lineTo(it.endX, it.endY);
                    this.ctx.stroke();
                }
            },

            render() {
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.translate(this.camera.x, this.camera.y);
                this.ctx.scale(this.camera.zoom, this.camera.zoom);

                Object.values(this.drawings).forEach(it => this.drawItem(it));

                if(this.isDrawing && this.mode !== 'move') {
                    this.drawItem({
                        type: this.mode, color: this.currentColor,
                        size: document.getElementById('sizePicker').value,
                        points: this.currentPath, startX: this.startX, startY: this.startY,
                        endX: this.tempEnd?.x, endY: this.tempEnd?.y
                    });
                }
                requestAnimationFrame(() => this.render());
            },

            undo() {
                const q = query(ref(db, 'board_data'), limitToLast(1));
                get(q).then(s => { if(s.exists()) remove(ref(db, `board_data/${Object.keys(s.val())[0]}`)); });
            },

            clearBoard() { 
                if(this.isAdmin && confirm("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) remove(ref(db, 'board_data')); 
            },

            toggleChat() {
                const c = document.getElementById('chat-box');
                c.style.display = (c.style.display === 'flex') ? 'none' : 'flex';
            },

            sendChat(e) {
                if(e.key === 'Enter' && e.target.value.trim()) {
                    push(ref(db, 'chat'), { user: this.userName, msg: e.target.value });
                    e.target.value = "";
                }
            },

            startTimer() {
                let sec = 0;
                setInterval(() => {
                    sec++;
                    let m = Math.floor(sec/60);
                    let s = sec%60;
                    document.getElementById('timer').innerText = `â³ ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                }, 1000);
            }
        };

        window.rocket = rocket;
        rocket.init();
    </script>
</body>
</html>
