<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapora Pro | Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; }
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; background: #f4f7f6; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay {
            position: fixed; inset: 0; background: var(--primary); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .login-box { background: white; padding: 30px; border-radius: 15px; color: #333; text-align: center; }
        input[type="password"] { padding: 10px; margin: 10px; border: 1px solid #ccc; border-radius: 5px; width: 200px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        #sidebar {
            position: fixed; right: 10px; top: 50%; transform: translateY(-50%);
            background: white; padding: 15px; border-radius: 20px;
            display: flex; flex-direction: column; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 100;
        }
        .tool-btn { 
            width: 45px; height: 45px; border-radius: 10px; border: none; 
            cursor: pointer; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .tool-btn.active { background: var(--accent); color: white; }
        
        canvas { display: block; background: white; touch-action: none; }
        
        /* Ø§Ù„Ù…Ø³Ø·Ø±Ø© Ø§Ù„ÙˆÙ‡Ù…ÙŠØ© */
        #ruler-guide {
            position: absolute; border: 2px dashed var(--accent); pointer-events: none; display: none;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… (Ø§Ù„Ø£Ø¯Ù…Ù†)</h2>
            <input type="password" id="adminPass" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <br>
            <button onclick="checkAuth()" style="padding: 10px 20px; background: var(--accent); color:white; border:none; border-radius:5px;">Ø¯Ø®ÙˆÙ„</button>
            <p id="loginError" style="color:red; display:none;">ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø·Ø£!</p>
        </div>
    </div>

    <div id="sidebar">
        <input type="color" id="colorPicker" title="Ø§Ù„Ù„ÙˆÙ†">
        <button class="tool-btn active" id="penBtn" title="Ù‚Ù„Ù…">âœï¸</button>
        <button class="tool-btn" id="markerBtn" title="Ù…Ø§Ø±ÙƒØ±">ğŸ–ï¸</button>
        <button class="tool-btn" id="eraserBtn" title="Ø§Ø³ØªÙŠÙƒØ©">ğŸ§½</button>
        <button class="tool-btn" id="rulerBtn" title="Ù…Ø³Ø·Ø±Ø©">ğŸ“</button>
        <hr>
        <button class="tool-btn" id="undoBtn" title="ØªØ±Ø§Ø¬Ø¹">â†©ï¸</button>
        <button class="tool-btn" id="clearBtn" title="Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„" style="background: #ffdada;">ğŸ—‘ï¸</button>
        <hr>
        <button class="tool-btn" onclick="document.getElementById('fileInput').click()" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯">ğŸ“</button>
        <input type="file" id="fileInput" hidden accept="image/*">
    </div>

    <canvas id="whiteboard"></canvas>
    <div id="ruler-guide"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVFNJhGIlOjyJgSGj9MqK4Xt89p_irSEQ",
            authDomain: "sapora-f738b.firebaseapp.com",
            projectId: "sapora-f738b",
            storageBucket: "sapora-f738b.firebasestorage.app",
            messagingSenderId: "6892834042",
            appId: "1:6892834042:web:1993b52a61315ba5028d43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const streamRef = ref(db, 'board_data/stream');
        const controlRef = ref(db, 'board_data/control');

        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let drawing = false;
        let mode = 'pen'; // pen, marker, eraser, ruler
        let history = []; // Ù„Ù„ØªØ±Ø§Ø¬Ø¹
        let startX, startY;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† (ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: 123)
        window.checkAuth = () => {
            const pass = document.getElementById('adminPass').value;
            if(pass === "123") {
                document.getElementById('login-overlay').style.display = 'none';
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        };

        // ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø¯ÙˆØ§Øª
        document.getElementById('penBtn').onclick = () => setMode('pen');
        document.getElementById('markerBtn').onclick = () => setMode('marker');
        document.getElementById('eraserBtn').onclick = () => setMode('eraser');
        document.getElementById('rulerBtn').onclick = () => setMode('ruler');

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(m + 'Btn').classList.add('active');
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ØªÙØ§Ø¹Ù„
        canvas.addEventListener('pointerdown', (e) => {
            drawing = true;
            startX = e.clientX;
            startY = e.clientY;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù„Ù„ØªØ±Ø§Ø¬Ø¹)
            history.push(canvas.toDataURL());
        });

        canvas.addEventListener('pointermove', (e) => {
            if (!drawing) return;
            
            const x = e.clientX;
            const y = e.clientY;
            const color = document.getElementById('colorPicker').value;

            ctx.lineCap = "round";
            ctx.lineJoin = "round";

            if (mode === 'pen') {
                ctx.lineWidth = 2;
                ctx.globalAlpha = 1;
                ctx.strokeStyle = color;
                drawAndEmit(x, y);
            } else if (mode === 'marker') {
                ctx.lineWidth = 20;
                ctx.globalAlpha = 0.3; // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù„Ù„Ù…Ø§Ø±ÙƒØ±
                ctx.strokeStyle = color;
                drawAndEmit(x, y);
            } else if (mode === 'eraser') {
                ctx.lineWidth = 40;
                ctx.globalAlpha = 1;
                ctx.strokeStyle = "#ffffff";
                drawAndEmit(x, y);
            }
        });

        function drawAndEmit(x, y) {
            ctx.lineTo(x, y);
            ctx.stroke();
            set(streamRef, { 
                x, y, 
                color: ctx.strokeStyle, 
                width: ctx.lineWidth, 
                alpha: ctx.globalAlpha,
                mode: mode,
                time: Date.now() 
            });
        }

        canvas.addEventListener('pointerup', () => { drawing = false; });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        onValue(streamRef, (snapshot) => {
            const d = snapshot.val();
            if(d && !drawing) { // Ø§Ù„Ø±Ø³Ù… ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ³ØªÙ‚Ø¨Ù„
                ctx.lineWidth = d.width;
                ctx.globalAlpha = d.alpha;
                ctx.strokeStyle = d.color;
                ctx.lineTo(d.x, d.y);
                ctx.stroke();
            }
        });

        // Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹ (Undo)
        document.getElementById('undoBtn').onclick = () => {
            if (history.length > 0) {
                let prevImg = new Image();
                prevImg.src = history.pop();
                prevImg.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(prevImg, 0, 0);
                };
            }
        };

        // Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
        document.getElementById('clearBtn').onclick = () => {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                set(controlRef, { action: 'clear', time: Date.now() });
            }
        };

        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØµÙˆØ± ÙˆÙ…Ù„ÙØ§Øª
        document.getElementById('fileInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 50, 50, 400, 300);
                img.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

    </script>
</body>
</html>
